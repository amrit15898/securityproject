{% extends "base.html" %}

{% block content %}
{% include "datatable.html" %}
<div class="col-md-9 col-lg-12 px-md-4 add-pointer-btn" id="top-col">
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 ">
      <h1 class="h2">Avalanche CSV File Datas</h1>
      <div class="btn-toolbar mb-2 mb-md-0">
        <button class="btn  rounded ms-1 btn-purple" onclick="send_avalanche_packet()" id="send-btn">Confirm & Send</button>
        <a href="/message/show-avalanche-csv-logs-messages/" target="_blank" class="btn btn-danger bg-danger ms-2">Show Logs</a>
      </div>
 </div>
  
</div>

<div class="d-flex justify-content-center d-none" id="message-not-send">
  <div class=" w-50 d-flex justify-content-center">
    <p class="text-danger py-2 px-4 border border-warning rounded"> Message not send because of Websocket not connected.</p>
    </div>
</div>

<div class="col-md-9 col-lg-12 px-md-4 mt-4 point-table" id="table-col">
    <table id="example" class="table table-striped table-content" style="width:100%">
        <thead>
            <tr>
                <th class="text-capitalize">date</th>
                {% if request.user.is_superuser %}
                <th class="text-capitalize">grid id</th>
                <th class="text-capitalize">no of axis</th>
                <th class="text-capitalize">avalanche axis</th>
                <th class="text-capitalize">avalanche code</th>
                <th>Packet</th>
                {% else %}
                <th class="text-capitalize">avalanche code</th>
                {% endif  %}
                <th>Status</th>

            </tr>
        </thead>
        <tbody>
      
        </tbody>
</table>

{% load static %}
<div class="position-absolute mt-5" id="loader" style="margin-left:27%;">
    <div>
        <img src="{% static 'images/loader-unscreen.gif' %}" width="200px" alt="">
    <h5 class="ms-1">Please wait data is loading...</h5>
    </div>
</div> 


<div class="mt-5 d-none" id="send-loader" style="margin-left:27%; position: absolute;top: 321px;">
  <div>
      <img src="{% static 'images/loader-unscreen.gif' %}" width="200px" alt="">
    <h5 class="ms-1">message sending please wait...</h5>
  </div>
</div> 

</div>
</div>

</div>

<div class="col-md-9 col-lg-12 px-md-4 mt-3 shadow-lg   bg-body-tertiary px-4 pt-3 rounded d-none" id="form2">

<form method="post"  class="p-5" action="/message/avalanche-csv-file/" enctype="multipart/form-data">
  {% csrf_token %}
  <div class="alert alert-danger" role="alert">
     Invalid csv file format please check and re-upload
  </div>

  
   <div class="containerr">
    <input type="file" class="form-control" name="file" id="file"  required >
</div>

  <div class="row my-4">
    <div class="col-5">
        <button type="submit" class="btn btn-purple w-25" >Send</button>
        <button type="reset" class="btn btn-info w-50 text-white ms-1">Download File Format</button>
    </div>
</div>
</form>

</div>






<script>
  function make_datatable(){
    $(document).ready(function () {
        $('#example').DataTable();
    });
 }
  
    var t = $('#example').DataTable();
    var all_data;

    fetch('/message/avalanche-upload-file/')
  .then((response) => response.json())
  .then((data) => {
    if(data["invalid"] === true){
      $('#table-col').addClass("d-none")
      $('#top-col').addClass("d-none")
      $('#form2').removeClass("d-none")
    }
    $('#loader').addClass("d-none")
    $('#example').removeClass("d-none")
    make_datatable()
    data.forEach(myFunction);
    all_data = data
  });



  function avalanche_axis_id(arr){
    arr.forEach(element => {
          
    });
  }

  
  function avalanche_packet(packet,packet2, id){
   
    return `
            <!-- Button trigger modal -->
        <button type="button" class="btn btn-sm btn-purple" data-bs-toggle="modal" data-bs-target="#exampleModal`+id+`">
        Packet
        </button>

        <!-- Modal -->
        <div class="modal fade" id="exampleModal`+id+`" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="exampleModalLabel">packet of id `+id+`</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>
                `+packet+`<br> `+packet2+`
            </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
            </div>
        </div>
        </div>
    `
  }

  {% if request.user.is_superuser %}
  function myFunction(item) {
    t.row.add([item.date,item.grid_id,item.no_of_axis,item.avalanche_axis,item.avalanche_code, avalanche_packet(item.packet,item.packet2,item.id), `<div id="`+item.id+`"><i class="bi bi-exclamation-circle"></i></div>`]).draw(false);
  }
{% else %}

function myFunction(item) {
  t.row.add([item.date, item.avalanche_code, `<div id="`+item.id+`"><i class="bi bi-exclamation-circle"></i></div>`]).draw(false);
}
{% endif %}
  
 
  function send_avalanche_packet(){
    $("#send-btn").addClass("disabled");
    $("#send-btn").addClass("btn-primary");
    $("#send-btn").html('Sending');
    $('#send-loader').removeClass('d-none')

    $.ajax({
      url: full_host+'/message/avalanche-packet-sender/',
      type: 'POST',
      data: {packets : JSON.stringify(all_data)},
     
      success: function(response) { 
        $('#send-loader').addClass('d-none')
        t.clear()
        for(var res=0; res < response.length;res++){
         if(response[res].status === true){
           document.getElementById(response[res].id).innerHTML=`<i class="bi bi-check2 text-success" style="width:70px;"></i>`
          }
          else{
           document.getElementById(response[res].id).innerHTML=`<i class="bi bi-x-lg text-danger"></i>`
          }
        }
   

       },
       error: function (response) {
           console.log(response)
           $('#message-not-send').removeClass('d-none');
           $('#send-loader').addClass('d-none')
       }
    });

    $("#send-btn").html('Sended');
  }



</script>
{% endblock %}